<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: #2a2a2a;
            padding: 15px 30px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 1.3em;
            font-weight: 700;
            color: #4a9eff;
        }

        .broadcast-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .broadcast-title {
            font-size: 0.95em;
            color: #e0e0e0;
        }

        .live-badge {
            background: #ff4444;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .stats-info {
            display: flex;
            gap: 20px;
            font-size: 0.85em;
            color: #999;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            color: #4a9eff;
            font-weight: 600;
        }

        /* Controls */
        .controls {
            background: #252525;
            padding: 15px 30px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group label {
            font-size: 0.85em;
            color: #999;
            white-space: nowrap;
        }

        .input-group input {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            width: 120px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 7px 16px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #3a8eef;
        }

        .btn-refresh {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
        }

        .btn-refresh:hover {
            background: #3a3a3a;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .auto-refresh input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .auto-refresh label {
            font-size: 0.85em;
            color: #999;
            cursor: pointer;
        }

        /* Table Container */
        .table-container {
            flex: 1;
            overflow: auto;
            background: #1a1a1a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #2a2a2a;
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #999;
            border-bottom: 1px solid #3a3a3a;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            color: #4a9eff;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #2a2a2a;
            color: #e0e0e0;
        }

        tbody tr {
            transition: background 0.15s;
        }

        tbody tr:hover {
            background: #252525;
        }

        tbody tr.new-row {
            animation: highlightNew 2s ease;
        }

        @keyframes highlightNew {
            0% {
                background: #4a9eff33;
            }

            100% {
                background: transparent;
            }
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-data h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        /* Column specific styles */
        .col-no {
            width: 60px;
            text-align: center;
            color: #666;
        }

        .col-message-id {
            width: 150px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #999;
        }

        .col-time {
            width: 100px;
            color: #999;
        }

        .col-datetime {
            width: 160px;
            color: #999;
            font-size: 0.85em;
        }

        .col-nickname {
            width: 150px;
            font-weight: 600;
            color: #4a9eff;
        }

        .col-balloon {
            width: 100px;
            text-align: right;
            font-weight: 700;
            color: #ffaa00;
        }

        .col-message {
            min-width: 300px;
            color: #e0e0e0;
        }

        /* Status indicator */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #44ff44;
            box-shadow: 0 0 8px #44ff44;
        }

        .status-indicator.disconnected {
            background: #ff4444;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #3a3a3a;
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="logo">ğŸ¯ Live Tracker</div>
                <div class="broadcast-info">
                    <div class="broadcast-title" id="broadcastTitle">ë°©ì†¡ ëª¨ë‹ˆí„°ë§</div>
                    <span class="live-badge">LIVE</span>
                </div>
            </div>
            <div class="stats-info">
                <div class="stat-item">
                    <span>ì´ ë°ì´í„°:</span>
                    <span class="stat-value" id="totalCount">0</span>
                </div>
                <div class="stat-item">
                    <span>ì´ ë³„í’ì„ :</span>
                    <span class="stat-value" id="totalBalloons">0</span>
                </div>
                <div class="stat-item">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">ëŒ€ê¸° ì¤‘</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="input-group">
                <label>BJ ID:</label>
                <input type="text" id="bjId" value="" placeholder="BJ ID ì…ë ¥">
            </div>
            <div class="input-group">
                <label>ë°©ì†¡êµ­ ID:</label>
                <input type="text" id="stationId" value="" placeholder="ìë™ ê²€ìƒ‰ í´ë¦­">
                <button class="btn" onclick="autoFindStation()" style="padding: 7px 12px; margin-left: 5px;">ğŸ”
                    ìë™</button>
            </div>
            <div class="input-group">
                <label>í•­ëª© ìˆ˜:</label>
                <input type="number" id="perPage" value="100" min="10" max="100">
            </div>
            <div class="input-group" style="flex: 1; max-width: 300px;">
                <label>ğŸ” ê²€ìƒ‰:</label>
                <input type="text" id="searchInput" placeholder="ë‹‰ë„¤ì„, ë©”ì‹œì§€ ê²€ìƒ‰..." style="width: 100%;"
                    oninput="filterData()">
            </div>
            <button class="btn" onclick="loadData()">ì¡°íšŒ</button>
            <button class="btn btn-refresh" onclick="refreshData()">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="col-no">No.</th>
                        <th class="col-message-id">ë©”ì‹œì§€ID</th>
                        <th class="col-time sortable" onclick="sortBy('time')">ì‹œê°„ â–¼</th>
                        <th class="col-datetime">ìƒì„±ì¼ì‹œ</th>
                        <th class="col-nickname sortable" onclick="sortBy('nickname')">ë‹‰ë„¤ì„</th>
                        <th class="col-balloon sortable" onclick="sortBy('balloon')">ë³„í’</th>
                        <th class="col-message">ë©”ì‹œì§€</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 15px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <script>
            let currentData = [];
            let allData = []; // ëˆ„ì ëœ ì „ì²´ ë°ì´í„°
            let filteredData = []; // í•„í„°ë§ëœ ë°ì´í„°
            let websocket = null;
            let reconnectInterval = null;
            let searchQuery = '';
            let broadcastStartTime = null;

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
            window.addEventListener('load', function () {
                connectWebSocket();
            });

            // í˜ì´ì§€ ì¢…ë£Œ ì‹œ WebSocket ë‹«ê¸°
            window.addEventListener('beforeunload', function () {
                if (websocket) {
                    websocket.close();
                }
            });

            // Enter í‚¤ ì§€ì› (loadDataê°€ connectWebSocketì„ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½)
            document.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    loadData();
                }
            });

            function connectWebSocket() {
                const bjId = document.getElementById('bjId').value;
                const stationId = document.getElementById('stationId').value;

                if (!bjId || !stationId) {
                    alert('BJ IDì™€ ë°©ì†¡êµ­ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return;
                }

                // ê¸°ì¡´ ì—°ê²° ì¢…ë£Œ
                if (websocket) {
                    websocket.close();
                }

                updateStatus('loading', 'ì—°ê²° ì¤‘...');

                // WebSocket ì—°ê²° (ë™ì  URL ìƒì„±)
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host;
                const wsUrl = `${protocol}//${host}/ws/monitor/${bjId}/${stationId}`;
                console.log('WebSocket ì—°ê²° ì‹œë„:', wsUrl);
                websocket = new WebSocket(wsUrl);

                websocket.onopen = function (e) {
                    console.log('WebSocket ì—°ê²° ì„±ê³µ');
                    updateStatus('connected', 'ì‹¤ì‹œê°„ ì—°ê²°ë¨');

                    // ì¬ì—°ê²° íƒ€ì´ë¨¸ ì´ˆê¸°í™”
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                };

                websocket.onmessage = function (event) {
                    try {
                        const message = JSON.parse(event.data);

                        if (message.type === 'initial') {
                            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                            allData = message.data;

                            // ì„œë²„ì—ì„œ ë°›ì€ ë°©ì†¡ ì‹œì‘ ì‹œê°„ ì‚¬ìš©
                            if (message.broadcast_start) {
                                broadcastStartTime = new Date(message.broadcast_start);
                                console.log('ë°©ì†¡ ì‹œì‘ ì‹œê°„:', message.broadcast_start);
                            } else if (allData.length > 0) {
                                // ì„œë²„ì—ì„œ ì œê³µí•˜ì§€ ì•Šìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ëœ ë°ì´í„° ì‚¬ìš©
                                const oldestData = allData[allData.length - 1];
                                if (oldestData.CREATE_DATE) {
                                    broadcastStartTime = new Date(oldestData.CREATE_DATE);
                                }
                            }

                            applyFilter();
                            console.log('ì´ˆê¸° ë°ì´í„° ë¡œë“œ:', allData.length + 'ê°œ');

                        } else if (message.type === 'update') {
                            // ìƒˆ ë°ì´í„° ì¶”ê°€
                            const newItems = message.data;
                            allData = [...newItems, ...allData];

                            // ë°©ì†¡ ì‹œì‘ ì‹œê°„ì´ ì—†ìœ¼ë©´ ì„¤ì •
                            if (!broadcastStartTime && allData.length > 0) {
                                const oldestData = allData[allData.length - 1];
                                if (oldestData.CREATE_DATE) {
                                    broadcastStartTime = new Date(oldestData.CREATE_DATE);
                                }
                            }

                            applyFilter();

                            // ìƒˆ ë°ì´í„° í•˜ì´ë¼ì´íŠ¸
                            const newFilteredCount = newItems.filter(item => {
                                if (!searchQuery) return true;
                                const nickname = (item.BALLON_USER_NAME || '').toLowerCase();
                                const message = (item.MESSAGE || '').toLowerCase();
                                return nickname.includes(searchQuery) || message.includes(searchQuery);
                            }).length;

                            if (newFilteredCount > 0) {
                                renderTable(true, newFilteredCount);
                            }

                            console.log('ìƒˆ ë°ì´í„° ì¶”ê°€:', newItems.length + 'ê°œ');

                        } else if (message.type === 'error') {
                            console.error('ì„œë²„ ì—ëŸ¬:', message.message);
                        }

                    } catch (error) {
                        console.error('ë©”ì‹œì§€ íŒŒì‹± ì—ëŸ¬:', error);
                    }
                };

                websocket.onerror = function (error) {
                    console.error('WebSocket ì—ëŸ¬:', error);
                    updateStatus('disconnected', 'ì—°ê²° ì—ëŸ¬');
                };

                websocket.onclose = function (event) {
                    console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
                    updateStatus('disconnected', 'ì—°ê²° ëŠê¹€');

                    // 3ì´ˆ í›„ ìë™ ì¬ì—°ê²° (ë” ë¹ ë¥¸ ì¬ì—°ê²°)
                    if (!reconnectInterval) {
                        reconnectInterval = setTimeout(() => {
                            console.log('ì¬ì—°ê²° ì‹œë„...');
                            updateStatus('loading', 'ì¬ì—°ê²° ì¤‘...');
                            connectWebSocket();
                        }, 3000);
                    }
                };
            }

            function loadData() {
                // WebSocket ì¬ì—°ê²°
                connectWebSocket();
            }

            function refreshData() {
                // ë°ì´í„° ì´ˆê¸°í™” í›„ ì¬ì—°ê²°
                allData = [];
                currentData = [];
                connectWebSocket();
            }

            async function autoFindStation() {
                const bjId = document.getElementById('bjId').value;

                if (!bjId) {
                    alert('BJ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return;
                }

                const stationInput = document.getElementById('stationId');
                const originalValue = stationInput.value;
                stationInput.value = 'ê²€ìƒ‰ ì¤‘...';
                stationInput.disabled = true;

                try {
                    const apiUrl = `${window.location.protocol}//${window.location.host}/api/find-station/${bjId}`;
                    const response = await fetch(apiUrl);
                    const data = await response.json();

                    if (data.success && data.is_live) {
                        stationInput.value = data.station_id;
                        stationInput.disabled = false;

                        // ë°©ì†¡ ì œëª© ì—…ë°ì´íŠ¸
                        if (data.title) {
                            document.getElementById('broadcastTitle').textContent = data.title;
                        }

                        alert(`âœ… ë°©ì†¡ ì¤‘ì¸ station_idë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!\në°©ì†¡ ì œëª©: ${data.title || 'ì•Œ ìˆ˜ ì—†ìŒ'}`);

                        // ìë™ìœ¼ë¡œ ì—°ê²°
                        connectWebSocket();
                    } else {
                        stationInput.value = originalValue;
                        stationInput.disabled = false;
                        alert('âŒ í˜„ì¬ ë°©ì†¡ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.\në°©ì†¡ ì¤‘ì¼ ë•Œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                } catch (error) {
                    console.error('Station ID ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                    stationInput.value = originalValue;
                    stationInput.disabled = false;
                    alert('âŒ Station ID ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            }

            function renderTable(highlightNew = false, newCount = 0) {
                const tbody = document.getElementById('tableBody');

                if (currentData.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            <h3>ğŸ“­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>ë‹¤ë¥¸ BJ IDë‚˜ ë°©ì†¡êµ­ IDë¥¼ ì‹œë„í•´ë³´ì„¸ìš”</p>
                        </td>
                    </tr>
                `;
                    return;
                }

                tbody.innerHTML = '';
                currentData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    // ìƒˆë¡œ ì¶”ê°€ëœ ë°ì´í„°ë§Œ í•˜ì´ë¼ì´íŠ¸
                    if (highlightNew && index < newCount) {
                        row.className = 'new-row';
                    }

                    row.innerHTML = `
                    <td class="col-no">${index + 1}</td>
                    <td class="col-message-id">${item.MESSAGE_ID || '-'}</td>
                    <td class="col-time">${formatElapsedTime(item.CREATE_DATE)}</td>
                    <td class="col-datetime">${formatAbsoluteTime(item.CREATE_DATE)}</td>
                    <td class="col-nickname">${item.BALLON_USER_NAME || '-'}</td>
                    <td class="col-balloon">${(item.BALLON_COUNT || 0).toLocaleString()}</td>
                    <td class="col-message">${item.MESSAGE || '-'}</td>
                `;
                    tbody.appendChild(row);
                });
            }

            function updateStats() {
                const totalCount = currentData.length;
                const totalBalloons = currentData.reduce((sum, item) => sum + (item.BALLON_COUNT || 0), 0);

                document.getElementById('totalCount').textContent = totalCount.toLocaleString();
                document.getElementById('totalBalloons').textContent = totalBalloons.toLocaleString();
            }

            function updateStatus(status, text) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');

                indicator.className = 'status-indicator';

                if (status === 'connected') {
                    indicator.classList.add('connected');
                } else if (status === 'disconnected') {
                    indicator.classList.add('disconnected');
                }

                statusText.textContent = text;
            }


            function filterData() {
                searchQuery = document.getElementById('searchInput').value.toLowerCase();
                applyFilter();
            }

            function applyFilter() {
                if (!searchQuery) {
                    filteredData = allData;
                } else {
                    filteredData = allData.filter(item => {
                        const nickname = (item.BALLON_USER_NAME || '').toLowerCase();
                        const message = (item.MESSAGE || '').toLowerCase();
                        return nickname.includes(searchQuery) || message.includes(searchQuery);
                    });
                }
                currentData = filteredData;
                renderTable(false, 0);
                updateStats();
            }

            // ê²½ê³¼ ì‹œê°„ í¬ë§· (MM:SS ë˜ëŠ” HH:MM:SS)
            function formatElapsedTime(dateString) {
                if (!dateString || !broadcastStartTime) return '-';

                const currentTime = new Date(dateString);
                const elapsed = Math.floor((currentTime - broadcastStartTime) / 1000);

                if (elapsed < 0) {
                    console.warn('ê²½ê³¼ ì‹œê°„ì´ ìŒìˆ˜ì…ë‹ˆë‹¤:', elapsed);
                    return '0:00';
                }

                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;

                // 1ì‹œê°„ ë¯¸ë§Œì´ë©´ M:SS, ì´ìƒì´ë©´ H:MM:SS
                if (hours > 0) {
                    return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    return `${minutes}:${String(seconds).padStart(2, '0')}`;
                }
            }

            // ì ˆëŒ€ ì‹œê°„ í¬ë§· (ì‹¤ì œ ì‹œê°„ í‘œì‹œ)
            function formatAbsoluteTime(dateString) {
                if (!dateString) return '-';

                // CREATE_DATEì—ì„œ ì‹œê°„ ë¶€ë¶„ë§Œ ì¶”ì¶œ (HH:MM:SS)
                const timePart = dateString.split(' ')[1] || dateString;
                return timePart;
            }



            function sortBy(column) {
                if (column === 'time') {
                    currentData.sort((a, b) => {
                        return new Date(b.CREATE_DATE) - new Date(a.CREATE_DATE);
                    });
                } else if (column === 'nickname') {
                    currentData.sort((a, b) => {
                        return (a.BALLON_USER_NAME || '').localeCompare(b.BALLON_USER_NAME || '');
                    });
                } else if (column === 'balloon') {
                    currentData.sort((a, b) => {
                        return (b.BALLON_COUNT || 0) - (a.BALLON_COUNT || 0);
                    });
                }
                renderTable();
            }
        </script>
</body>

</html>